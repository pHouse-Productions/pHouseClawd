# pHouseClawd System Architecture

This document describes how the watcher system works. For assistant identity and behavior, see `SOUL.md`.

**Note:** `CLAUDE.md` is auto-generated by merging `SOUL.md` + `SYSTEM.md` before each job. Don't edit `CLAUDE.md` directly - edit the source files instead.

## How Messages Flow

Each message spawns a fresh Claude Code session. The watcher handles:
- Receiving messages from channels (Telegram, Discord, email, Google Chat)
- Spawning Claude sessions with appropriate context
- Relaying output back to the source channel

**Restarts:** Only needed when code changes
- `pm2 restart watcher` - when watcher code changes
- `pm2 restart dashboard-api` - when dashboard code changes

## Dashboard

```
Caddy (HTTPS) → /api/*       → Express API (port 3100)
              → /dashboard/* → Static React (Caddy serves dist/)
```

## Output Relay System

Chat surfaces receive assistant output automatically via the watcher's relay system.

**Verbosity Levels:**
- `streaming` (default for Telegram/Discord): Text streams as it's generated
- `progress`: Only tool use notifications
- `final` (default for email): All text sends when complete

**IMPORTANT - Regular responses are auto-relayed:**
- Text output is automatically sent to the source channel
- Just output text normally - no MCP tools needed
- Only use send_message/send_email for out-of-band notifications

**Attachments require MCP tools:**
- The relay only handles text, NOT files
- Use appropriate MCP tools (send_file, send_document, send_photo) for attachments

## Watcher Commands

Users can send these commands in any channel:

| Command | Description |
|---------|-------------|
| `/new` | Start a fresh session (clears context) |
| `/memory` | Show current memory mode |
| `/memory session` | Keep full context within session |
| `/memory transcript` | Fresh session but sees recent history |
| `/queue on/off` | Toggle message queuing |
| `/stop` | Kill current running job |
| `/restart` | Restart watcher service |

## Memory System

Two-tier system for persistent context across sessions.

### Long-term Memory
**Location:** `/home/ubuntu/pHouseClawd/memory/long-term/`

Persistent markdown files for important information:
- `journal.md` - Daily notes, decisions, events
- `projects.md` - Active projects and their status
- `people.md` - People Mike works with, contacts
- `learnings.md` - Things learned, preferences discovered
- `fitness.md` - Workout tracking, fitness goals

Use standard Read/Edit/Write tools to access these files. Create new files as needed for new categories.

### Short-term Memory
**Location:** `/home/ubuntu/pHouseClawd/memory/short-term/buffer.txt`

Rolling conversation buffer in JSONL format - recent messages across all channels. The watcher appends every message here with structured metadata (timestamp, channel, direction, sender).

When the buffer exceeds the threshold (~50KB), the watcher extracts a chunk to `memory/rollup-pending/` and spawns a background job to roll up important information to long-term memory.

### Best Practices
- Read relevant long-term files at session start for context
- Save important decisions/info to appropriate long-term files
- Check short-term buffer to see recent conversation history
- Keep long-term files organized - don't dump everything in journal

## Skills

Skills are defined in `/home/ubuntu/pHouseClawd/config/skills/` and provide specialized workflows. They're invoked via `/skill-name` syntax in any channel.

Available skills are shown in the system prompt. Use the `Skill` tool to invoke them.

## MCP Servers

MCP (Model Context Protocol) servers provide tool integrations. All custom MCP servers live in the **pHouseMcp** repo (`/home/ubuntu/pHouseMcp`), which is separate from pHouseClawd.

### Architecture

```
pHouseMcp/
├── packages/           # Shared libraries
│   ├── common/         # File ops, schemas
│   ├── google-auth/    # Shared Google OAuth
│   └── http-transport/ # HTTP transport for persistent servers
├── servers/            # Individual MCP servers (13 total)
│   ├── cron/           # Scheduled tasks
│   ├── gmail/          # Email read/send/filters
│   ├── google-calendar/# Calendar events
│   ├── google-docs/    # Docs CRUD
│   ├── google-drive/   # File management
│   ├── google-sheets/  # Spreadsheets
│   ├── google-chat/    # Chat messaging
│   ├── google-places/  # Business search
│   ├── telegram/       # Messaging + reactions
│   ├── discord/        # Messaging + reactions
│   ├── finnhub/        # Stock data
│   ├── image-gen/      # AI image generation
│   └── pdf/            # PDF conversion
└── .env                # API keys and credentials
```

### HTTP Mode

All MCP servers run as a single shared systemd service (`mcp-servers`) instead of spawning per-session subprocesses. This saves ~1.5GB RAM per session.

**Port Mapping:**
| Server | Port |
|--------|------|
| cron | 3002 |
| gmail | 3003 |
| google-calendar | 3004 |
| google-docs | 3005 |
| google-drive | 3006 |
| google-places | 3007 |
| google-sheets | 3008 |
| telegram | 3009 |
| discord | 3010 |
| google-chat | 3011 |
| finnhub | 3012 |
| image-gen | 3013 |
| pdf | 3014 |

### Managing MCP Servers

```bash
# Service management
sudo systemctl status mcp-servers
sudo systemctl restart mcp-servers
sudo systemctl stop mcp-servers

# View logs
tail -f /home/ubuntu/pHouseMcp/logs/mcp-servers.log

# Health check
cd /home/ubuntu/pHouseMcp && npm run http:test
```

### After Code Changes

When modifying MCP server code:
```bash
cd /home/ubuntu/pHouseMcp
npm run build                        # Rebuild TypeScript
sudo systemctl restart mcp-servers   # Restart service
```

Active Claude sessions reconnect automatically.

### Key MCP Tools Reference

**Cron (scheduling):**
- `create_job` - Recurring tasks (cron or human-readable schedule)
- `schedule_once` - One-off delayed tasks
- `list_jobs`, `edit_job`, `delete_job`, `toggle_job`

**Messaging (Telegram, Discord, Google Chat):**
- `send_message`, `send_file/document/photo`
- `get_history` - Recent messages
- `add_reaction`, `remove_reaction`

**Google Services:**
- Docs: `create_document`, `read_document`, `update_document`
- Sheets: `read_spreadsheet`, `write_spreadsheet`, `append_to_spreadsheet`
- Drive: `search_files`, `upload_file`, `share_file`, `create_folder`
- Calendar: `list_events`, `create_event`, `update_event`, `delete_event`

**Utilities:**
- `generate_image`, `edit_image` - AI image generation
- `convert_pdf_to_markdown`, `convert_pdf_to_images`
- `get_stock_quote`, `get_company_news` - Stock data
- `search_places`, `nearby_search`, `get_place_details` - Local business search

### Adding a New MCP Server

1. Create `servers/your-server/` with `src/mcp.ts`, `package.json`, `tsconfig.json`
2. Import `@phouse/http-transport` for HTTP support
3. Add port mapping to `mcp-servers.json`
4. Update `scripts/switch-to-http.sh` and `scripts/switch-to-stdio.sh`
5. Build and restart: `npm run build && sudo systemctl restart mcp-servers`
6. Register with Claude: `claude mcp add -s user --transport http your-server http://127.0.0.1:<port>/mcp`

---
*Last updated: 2026-02-01*
